<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>多語手寫朗讀工具</title>
    <meta name="theme-color" content="#0ea5e9" />
    <style>
        :root {
            --bg: #0b1220;
            --card: #111827;
            --muted: #6b7280;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --btn: #0ea5e9;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #0b1220, #0f172a);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        .wrap {
            max-width: 680px;
            margin: 0 auto;
            padding: clamp(16px, 5vw, 28px);
        }

        .app {
            background: linear-gradient(180deg, #0c1222, #0c1827);
            border: 1px solid #1f2937;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid #1f2937;
            background: #0b1220;
            position: sticky;
            top: 0;
        }

        header .logo {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: radial-gradient(circle at 30% 30%, #22d3ee, #0ea5e9 60%, #0369a1);
        }

        .section {
            padding: 16px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 14px
        }

        .label {
            font-size: 13px;
            color: #cbd5e1
        }

        textarea,
        select,
        input[type=range] {
            width: 100%;
            border-radius: 14px;
            border: 1px solid #1f2937;
            background: #0b1220;
            color: var(--text);
            padding: 14px;
            font-size: 16px;
            resize: vertical;
        }

        canvas {
            width: 100%;
            height: 50vh;
            background: #111827;
            border-radius: 16px;
            touch-action: none;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 8px 0
        }

        .chip {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid #1f2937;
            background: #0b1220;
            color: #cbd5e1;
            font-size: 13px;
            cursor: pointer;
        }

        button {
            flex: 1;
            border: none;
            border-radius: 14px;
            padding: 14px 16px;
            font-weight: 600;
            font-size: 16px;
        }

        .primary {
            background: var(--btn);
            color: #00111a
        }

        .danger {
            background: var(--danger);
            color: #fff
        }

        #ipa {
            color: #22d3ee;
            text-align: center;
            padding: 8px 0;
            white-space: pre-wrap
        }

        /* ---- 並排 row ---- */
        .row-fields {
            display: flex;
            flex-direction: row;
            gap: 16px;
            margin-bottom: 14px;
            flex-wrap: nowrap;
        }

        .row-fields .sub-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .pad-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div class="wrap">
        <div class="app">
            <header>
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <h1 style="margin:0;font-size:18px;">多語手寫語音工具</h1>
                    <p style="margin:0;font-size:12px;color:#6b7280">支援手寫 + 語音 + IPA · Mobile-first</p>
                </div>
                <!-- firebase -->
                <!-- 登入面板 -->
                <div id="loginPanel">
                    <button id="loginBtn">使用 Google 登入</button>
                    <button id="logoutBtn" class="hidden">登出</button>
                    <span id="userInfo"></span>
                </div>

                <!-- API Key 設定（可收合） -->
                <div id="keyWrapper" class="hidden" style="margin-top:10px;">
                    <button id="toggleKeyBtn" class="primary" style="margin-bottom:5px;">▼ 顯示 GPT 設定</button>
                    <div id="keySection" style="display:none;">
                        <input id="gptKey" placeholder="輸入你的 OpenAI API Key" style="width:300px;">
                        <button id="saveKeyBtn">儲存 API Key</button>
                        <p id="status"></p>
                    </div>
                </div>

            </header>

            <div class="section">

                <!-- 語言 / 語音 -->
                <div class="row-fields">
                    <div class="sub-field">
                        <label class="label" for="lang">選擇語言</label>
                        <select id="lang">
                            <option value="en-US">English 🇺🇸</option>
                            <option value="it-IT">Italiano 🇮🇹</option>
                            <option value="zh-TW">中文 (繁體) 🇹🇼</option>
                            <option value="ja-JP">日本語 🇯🇵</option>
                            <option value="fr-FR">Français 🇫🇷</option>
                            <option value="de-DE">Deutsch 🇩🇪</option>
                            <option value="es-ES">Español 🇪🇸</option>
                            <option value="pt-PT">Português 🇵🇹</option>
                            <option value="ru-RU">Русский 🇷🇺</option>
                            <option value="hi-IN">हिन्दी / اُردُو (印地-烏爾都語) 🇮🇳</option>
                            <option value="bn-BD">বাংলা (孟加拉語) 🇧🇩</option>
                            <option value="fa-IR">فارسی (波斯語) 🇮🇷</option>
                            <option value="ta-IN">தமிழ் (坦米爾語) 🇮🇳</option>
                            <option value="ar-SA">العربية (阿拉伯語) 🇸🇦</option>
                            <option value="tr-TR">Türkçe (土耳其語) 🇹🇷</option>
                            <option value="ko-KR">한국어 🇰🇷</option>
                            <option value="vi-VN">Tiếng Việt 🇻🇳</option>
                            <option value="id-ID">Bahasa Indonesia / Melayu 🇮🇩</option>
                            <option value="th-TH">ไทย 🇹🇭</option>
                            <option value="sw-KE">Kiswahili (斯瓦希里語) 🇰🇪</option>
                        </select>
                    </div>
                    <div class="sub-field">
                        <label class="label" for="voice">語音選擇</label>
                        <select id="voice"></select>
                    </div>
                </div>


                <!-- 輸入文字 -->
                <div class="field">
                    <label class="label">輸入要朗讀的文字（也會顯示在手寫區背景）</label>
                    <textarea id="text" placeholder="例如：Ciao! Come stai?"></textarea>
                    <div class="chips" id="samples"></div>
                </div>

                <!-- 語速 / 音高 -->
                <div class="row-fields">
                    <div class="sub-field">
                        <label class="label">語速 <span id="rateVal">1.0</span></label>
                        <input type="range" id="rate" min="0.6" max="1.6" step="0.1" value="1.0">
                    </div>
                    <div class="sub-field">
                        <label class="label">音高 <span id="pitchVal">1.0</span></label>
                        <input type="range" id="pitch" min="0.6" max="1.4" step="0.1" value="1.0">
                    </div>
                </div>

                <!-- 字體大小 -->
                <div class="field">
                    <label class="label">字體大小 <span id="fontSizeVal">72</span> px</label>
                    <input type="range" id="fontSize" min="16" max="240" step="1" value="32">
                </div>

                <div id="ipa" style="display:none"></div>

                <!-- 手寫區 -->
                <div class="field">
                    <label class="label">手寫練習區</label>
                    <canvas id="pad"></canvas>
                    <div class="pad-actions">
                        <button class="danger" id="clearBtn">🧹 清除畫布</button>
                        <button class="primary" id="speakBtn">▶ 開始朗讀</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase 初始化（用你的專案資訊） ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqZLFskqgyiAEc127dh95rXsOPQVLSurM",
            authDomain: "test-5dbba.firebaseapp.com",
            projectId: "test-5dbba",
            storageBucket: "test-5dbba.appspot.com",
            messagingSenderId: "878665537417",
            appId: "1:878665537417:web:xxxxxx" // 請到 Firebase 專案設定複製正確 appId
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === Google TTS 主要口音分組設定 ===
        const VOICE_VARIANTS = {
            "zh-TW": { include: ["cmn-TW", "cmn-CN"], labels: { "cmn-TW": "台灣", "cmn-CN": "中國" } },
            "en-US": { include: ["en-US", "en-GB", "en-AU", "en-CA"], labels: { "en-US": "美式", "en-GB": "英式", "en-AU": "澳洲", "en-CA": "加拿大" } },
            "de-DE": { include: ["de-DE", "de-AT", "de-CH"], labels: { "de-DE": "德國", "de-AT": "奧地利", "de-CH": "瑞士" } },
            "es-ES": { include: ["es-ES", "es-MX", "es-US", "es-AR"], labels: { "es-ES": "西班牙", "es-MX": "墨西哥", "es-US": "美國", "es-AR": "阿根廷" } },
            "pt-PT": { include: ["pt-PT", "pt-BR"], labels: { "pt-PT": "歐洲", "pt-BR": "巴西" } },
            "fr-FR": { include: ["fr-FR", "fr-CA"], labels: { "fr-FR": "法國", "fr-CA": "加拿大" } },
            "it-IT": { include: ["it-IT"], labels: { "it-IT": "義大利" } },
            "ru-RU": { include: ["ru-RU"], labels: { "ru-RU": "俄羅斯" } },
            "hi-IN": { include: ["hi-IN", "ur-PK"], labels: { "hi-IN": "印地語", "ur-PK": "烏爾都語" } },
            "bn-BD": { include: ["bn-BD", "bn-IN"], labels: { "bn-BD": "孟加拉", "bn-IN": "印度孟加拉" } },
            "fa-IR": { include: ["fa-IR", "fa-AF"], labels: { "fa-IR": "伊朗", "fa-AF": "阿富汗" } },
            "ta-IN": { include: ["ta-IN", "ta-LK"], labels: { "ta-IN": "印度", "ta-LK": "斯里蘭卡" } },
            "ar-SA": { include: ["ar-SA", "ar-EG", "ar-XA"], labels: { "ar-SA": "沙烏地", "ar-EG": "埃及", "ar-XA": "汎阿拉伯" } },
            "tr-TR": { include: ["tr-TR"], labels: { "tr-TR": "土耳其" } },
            "ja-JP": { include: ["ja-JP"], labels: { "ja-JP": "日本" } },
            "ko-KR": { include: ["ko-KR"], labels: { "ko-KR": "韓國" } },
            "vi-VN": { include: ["vi-VN"], labels: { "vi-VN": "越南（北部）" } },
            "id-ID": { include: ["id-ID", "ms-MY"], labels: { "id-ID": "印尼語", "ms-MY": "馬來語" } },
            "th-TH": { include: ["th-TH"], labels: { "th-TH": "泰國" } },
            "sw-KE": { include: ["sw-KE", "sw-TZ"], labels: { "sw-KE": "肯亞", "sw-TZ": "坦尚尼亞" } }
        };

        // --- UI 元素 ---
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const keySection = document.getElementById('keySection');
        const gptKeyInput = document.getElementById('gptKey');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const statusEl = document.getElementById('status');

        const langSel = document.getElementById('langSel');
        const accentWrap = document.getElementById('accentWrap');
        const accentSel = document.getElementById('accentSel');
        const accentHint = document.getElementById('accentHint');
        const wordInput = document.getElementById('wordInput');
        const promptBox = document.getElementById('promptBox');
        const genBtn = document.getElementById('genBtn');
        const resultBox = document.getElementById('resultBox');
        const runStatus = document.getElementById('runStatus');

        let currentUser = null;
        let gptKey = null;
        let lastIPAQuery = { text: '', lang: '', ipa: '' };


        // === 登入 / 登出 ===
        loginBtn.onclick = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(err => alert("登入失敗：" + err.message));
        };
        logoutBtn.onclick = () => auth.signOut();

        // ✅ 監聽登入狀態（這段一定要放在 Firebase 初始化之後）
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userInfo.textContent = `已登入：${user.email}`;
                keyWrapper.classList.remove('hidden');   // 顯示 API Key 區塊

                // 讀取 Firestore 使用者的 Key
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    const gptKey = doc.exists ? doc.data().gptApiKey : null;
                    if (gptKey) {
                        gptKeyInput.value = gptKey;
                        statusEl.textContent = "✅ 已載入 Firestore 中的 gptApiKey";
                    } else {
                        statusEl.textContent = "⚠️ 尚未儲存 API Key";
                    }
                } catch (e) {
                    statusEl.textContent = "❌ 讀取失敗：" + e.message;
                }
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                userInfo.textContent = '';
                keyWrapper.classList.add('hidden'); // 登出時隱藏 API Key 區塊
            }
        });

        // ✅ 切換展開/收起
        toggleKeyBtn.addEventListener('click', () => {
            const isHidden = keySection.style.display === 'none';
            keySection.style.display = isHidden ? 'block' : 'none';
            toggleKeyBtn.textContent = isHidden ? '▲ 隱藏 GPT 設定' : '▼ 顯示 GPT 設定';
        });

        // ✅ 儲存 Key
        saveKeyBtn.onclick = async () => {
            if (!auth.currentUser) return alert("請先登入！");
            const key = gptKeyInput.value.trim();
            if (!key) return alert("請輸入 API Key");
            try {
                await db.collection('users').doc(auth.currentUser.uid).set({
                    gptApiKey: key,
                    gptUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                statusEl.textContent = "✅ 已儲存到 Firestore！";
            } catch (err) {
                statusEl.textContent = "❌ 儲存失敗：" + err.message;
            }
        };

        // --- 根據語言載入口音選項 ---
        function refreshAccents() {
            const lang = langSel.value;
            accentSel.innerHTML = '';
            const variant = VOICE_VARIANTS[lang];

            if (variant && variant.include?.length) {
                accentWrap.classList.remove('hidden');
                variant.include.forEach(code => {
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = variant.labels?.[code] || code;
                    accentSel.appendChild(opt);
                });
                accentHint.textContent = "（可選擇主要口音/變體）";
            } else {
                accentWrap.classList.add('hidden');
                accentHint.textContent = "";
            }
            updatePromptPreview();
        }

        // --- 生成 Prompt 預覽 ---
        function updatePromptPreview() {
            const lang = langSel.options[langSel.selectedIndex].textContent.replace(/ ?🇧🇩| ?🇮🇳| ?🇯🇵| ?🇹🇼| ?🇺🇸| ?🇩🇪| ?🇪🇸| ?🇵🇹| ?🇫🇷| ?🇮🇹| ?🇷🇺| ?🇮🇷| ?🇸🇦| ?🇹🇷| ?🇰🇷| ?🇻🇳| ?🇮🇩| ?🇹🇭| ?🇰🇪/g, '').trim();
            const langCode = langSel.value;
            const hasAccent = !accentWrap.classList.contains('hidden');
            const accentCode = hasAccent ? accentSel.value : null;
            const accentLabel = hasAccent ? (VOICE_VARIANTS[langCode].labels?.[accentCode] || accentCode) : null;
            const word = (wordInput.value || "").trim();

            const prompt = `IPA for "${word}" in ${lang}${accentLabel ? ' (' + accentLabel + ')' : ''}. Only IPA.`;

            promptBox.value = prompt;
        }

        langSel.onchange = refreshAccents;
        accentSel.onchange = updatePromptPreview;
        wordInput.oninput = updatePromptPreview;

        // 初始載入
        refreshAccents();

        // --- 呼叫 OpenAI（用 Firestore 內的 gptApiKey 或輸入框的） ---
        async function callOpenAI(prompt) {
            const key = (gptKeyInput.value || '').trim();
            if (!key) throw new Error("尚未提供 OpenAI API Key");
            const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${key}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0
                })
            });
            const data = await resp.json();
            if (!resp.ok) {
                throw new Error(data.error?.message || "OpenAI 呼叫失敗");
            }
            return (data.choices?.[0]?.message?.content || "").trim();
        }

        // --- 執行產生 ---
        genBtn.onclick = async () => {
            const word = (wordInput.value || "").trim();
            if (!word) { alert("請先輸入單詞"); return; }
            const prompt = promptBox.value;
            runStatus.textContent = "⏳ 正在向 GPT 產生 IPA...";
            resultBox.textContent = "（產生中…）";
            genBtn.disabled = true;

            try {
                const ipa = await callOpenAI(prompt);
                resultBox.textContent = ipa || "（沒有回傳內容）";
                runStatus.textContent = "✅ 完成";
            } catch (e) {
                console.error(e);
                runStatus.textContent = "❌ 失敗";
                resultBox.textContent = "錯誤：" + e.message;
            } finally {
                genBtn.disabled = false;
            }
        };
    </script>
    <script>
        const langEl = document.getElementById('lang');
        const voiceEl = document.getElementById('voice');
        const textEl = document.getElementById('text');
        const rateEl = document.getElementById('rate');
        const pitchEl = document.getElementById('pitch');
        const rateVal = document.getElementById('rateVal');
        const pitchVal = document.getElementById('pitchVal');
        const fontSizeEl = document.getElementById('fontSize');
        const fontSizeVal = document.getElementById('fontSizeVal');
        const ipaEl = document.getElementById('ipa');
        const canvas = document.getElementById('pad');
        const ctx = canvas.getContext('2d');
        const samplesEl = document.getElementById('samples');
        const DPR = window.devicePixelRatio || 1;
        let strokes = []; let isDrawing = false; let currentStroke = null;
        let customFontSize = 72; // 由滑桿控制

        const SAMPLE_TEXTS = {
            "en-US": ["Hello", "Hi", "Good morning", "Good evening"],
            "it-IT": ["Ciao", "Salve", "Buongiorno", "Buonasera"],
            "zh-TW": ["你好", "嗨", "早安", "晚安"],
            "ja-JP": ["こんにちは", "やあ", "おはよう", "こんばんは"],
            "fr-FR": ["Bonjour", "Salut", "Bonsoir", "Coucou"],
            "de-DE": ["Hallo", "Guten Tag", "Guten Morgen", "Guten Abend"],
            "es-ES": ["Hola", "Buenos días", "Buenas tardes", "Buenas noches"],
            "pt-PT": ["Olá", "Oi", "Bom dia", "Boa noite"],
            "ru-RU": ["Привет", "Здравствуйте", "Доброе утро", "Добрый вечер"],
            "hi-IN": ["नमस्ते", "हैलो", "सुप्रभात", "शुभ संध्या"],
            "bn-BD": ["হ্যালো", "নমস্কার", "শুভ সকাল", "শুভ সন্ধ্যা"],
            "fa-IR": ["سلام", "درود", "صبح بخیر", "عصر بخیر"],
            "ta-IN": ["வணக்கம்", "ஹலோ", "காலை வணக்கம்", "மாலை வணக்கம்"],
            "ar-SA": ["مرحبا", "أهلا", "صباح الخير", "مساء الخير"],
            "tr-TR": ["Merhaba", "Selam", "Günaydın", "İyi akşamlar"],
            "ko-KR": ["안녕하세요", "안녕", "좋은 아침", "안녕히 주무세요"],
            "vi-VN": ["Xin chào", "Chào bạn", "Chào buổi sáng", "Chào buổi tối"],
            "id-ID": ["Halo", "Hai", "Selamat pagi", "Selamat malam"],
            "th-TH": ["สวัสดี", "หวัดดี", "อรุณสวัสดิ์", "สวัสดีตอนเย็น"],
            "sw-KE": ["Hujambo", "Habari", "Asubuhi njema", "Usiku mwema"]
        };




        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * DPR; canvas.height = rect.height * DPR;
            ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
            ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.strokeStyle = '#22d3ee';
            redraw();
        }
        window.addEventListener('resize', resizeCanvas);

        function wrapTextSmart(text, maxW, fontSize) {
            ctx.font = `${fontSize}px sans-serif`;
            const useWords = /\s/.test(text);
            const units = useWords ? text.split(/\s+/) : [...text];
            const lines = []; let line = '';
            for (const u of units) {
                const test = line ? (useWords ? line + ' ' + u : line + u) : u;
                if (ctx.measureText(test).width > maxW * 0.92 && line) { lines.push(line); line = u; }
                else line = test;
            }
            if (line) lines.push(line);
            return lines.slice(0, 6);
        }
        function drawBackgroundText() {
            const text = textEl.value.trim();
            ctx.save(); ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = 'rgba(200,200,200,0.25)';
            const maxW = canvas.width / DPR, maxH = canvas.height / DPR;
            if (text) {
                const fs = customFontSize;
                const lines = wrapTextSmart(text, maxW, fs);
                ctx.font = `${fs}px sans-serif`; const lh = fs * 1.2;
                const startY = (maxH / 2) - ((lines.length - 1) * lh / 2);
                lines.forEach((line, i) => ctx.fillText(line, maxW / 2, startY + i * lh));
            } else { ctx.font = '20px sans-serif'; ctx.fillText('在此手寫…', maxW / 2, maxH / 2); }
            ctx.restore();
        }
        function drawStrokes() {
            ctx.save(); ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 4; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
            const draw = s => {
                if (!s || s.length < 2) return; ctx.beginPath(); ctx.moveTo(s[0].x, s[0].y);
                for (let i = 1; i < s.length; i++)ctx.lineTo(s[i].x, s[i].y); ctx.stroke();
            };
            strokes.forEach(draw); if (currentStroke) draw(currentStroke); ctx.restore();
        }
        function redraw() { ctx.clearRect(0, 0, canvas.width, canvas.height); drawBackgroundText(); drawStrokes(); }

        function posFromEvent(e) { const r = canvas.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; }
        canvas.addEventListener('pointerdown', e => { canvas.setPointerCapture(e.pointerId); isDrawing = true; currentStroke = [posFromEvent(e)]; redraw(); });
        canvas.addEventListener('pointermove', e => { if (!isDrawing) return; currentStroke.push(posFromEvent(e)); redraw(); });
        function endStroke() { if (isDrawing && currentStroke?.length) { strokes.push(currentStroke); currentStroke = null; redraw(); } isDrawing = false; }
        canvas.addEventListener('pointerup', endStroke);
        canvas.addEventListener('pointercancel', endStroke);
        canvas.addEventListener('pointerleave', endStroke);
        document.getElementById('clearBtn').addEventListener('click', () => { strokes = []; redraw(); });

        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            const lang = langEl.value;
            voiceEl.innerHTML = '';

            const variant = VOICE_VARIANTS[lang];
            if (variant) {
                // 有設定主要口音的語言
                const list = voices.filter(v =>
                    variant.include.some(code => v.lang.startsWith(code))
                );
                if (list.length) {
                    list.forEach(v => {
                        const opt = document.createElement('option');
                        const label = variant.labels[v.lang] || v.lang;
                        opt.value = v.name;
                        opt.textContent = `${v.name}（${label}）`;
                        voiceEl.appendChild(opt);
                    });
                    return;
                }
            }

            // 沒有特別分組或找不到對應語音，就用原本的方式
            const list = voices.filter(v => v.lang === lang);
            (list.length ? list : voices).forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = `${v.name} (${v.lang})`;
                voiceEl.appendChild(opt);
            });
        }
        speechSynthesis.onvoiceschanged = loadVoices;

        function speakNow() {
            const text = textEl.value.trim();
            if (!text) return;
            const u = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            const sel = voices.find(v => v.name === voiceEl.value);
            if (sel) u.voice = sel;
            u.lang = langEl.value;
            u.rate = parseFloat(rateEl.value);
            u.pitch = parseFloat(pitchEl.value);
            speechSynthesis.cancel();
            speechSynthesis.speak(u);

            // ⚡ 如果文字有變才去查 GPT
            if (lastIPAQuery.text !== text || lastIPAQuery.lang !== langEl.value) {
                fetchIPA(text, langEl.value);
            } else {
                // 直接顯示快取
                ipaEl.style.display = 'block';
                ipaEl.textContent = `📘 IPA: ${lastIPAQuery.ipa}`;
            }
        }
        async function fetchIPA(text, langCode) {
            // 如果文字和語言都沒變，就直接用上次的結果
            if (lastIPAQuery.text === text && lastIPAQuery.lang === langCode && lastIPAQuery.ipa) {
                ipaEl.style.display = 'block';
                ipaEl.textContent = `📘 IPA: ${lastIPAQuery.ipa}`;
                return;
            }

            ipaEl.style.display = 'block';
            ipaEl.textContent = '🔄 查詢 IPA 中...';
            const sentence = text.trim();

            const gptKey = (document.getElementById('gptKey')?.value || '').trim();
            let ipa = '';

            if (gptKey) {
                try {
                    const langName = langEl.options[langEl.selectedIndex].textContent.replace(/ ?🇧🇩| ?🇮🇳| ?🇯🇵| ?🇹🇼| ?🇺🇸| ?🇩🇪| ?🇪🇸| ?🇵🇹| ?🇫🇷| ?🇮🇹| ?🇷🇺| ?🇮🇷| ?🇸🇦| ?🇹🇷| ?🇰🇷| ?🇻🇳| ?🇮🇩| ?🇹🇭| ?🇰🇪/g, '').trim();
                    const prompt = `Please write the full International Phonetic Alphabet (IPA) transcription for the following sentence in ${langName}: "${sentence}". Only output the IPA transcription, no explanations.`;
                    const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${gptKey}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: "gpt-4o-mini",
                            messages: [{ role: "user", content: prompt }],
                            temperature: 0
                        })
                    });
                    const data = await resp.json();
                    if (resp.ok && data.choices?.[0]?.message?.content) {
                        ipa = data.choices[0].message.content.trim();
                    }
                } catch (e) {
                    console.warn("GPT 查詢錯誤，fallback 字典API", e);
                }
            }

            // 如果 GPT 沒回傳，fallback 英文字典
            if (!ipa && langCode.startsWith("en")) {
                try {
                    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                    const data = await res.json();
                    ipa = data?.[0]?.phonetics?.find(p => p.text)?.text || '';
                } catch { }
            }

            if (ipa) {
                ipaEl.textContent = `📘 IPA: ${ipa}`;
                lastIPAQuery = { text, lang: langCode, ipa }; // 更新快取
            } else {
                ipaEl.textContent = '⚠️ 無法取得 IPA';
            }
        }


        langEl.addEventListener('change', () => {
            loadVoices(); textEl.placeholder = SAMPLE_TEXTS[langEl.value]?.[0] || ''; renderChips();
            if (langEl.value !== 'en-US') { ipaEl.style.display = 'none'; ipaEl.textContent = ''; }
        });
        rateEl.addEventListener('input', () => { rateVal.textContent = rateEl.value; });
        pitchEl.addEventListener('input', () => { pitchVal.textContent = pitchEl.value; });
        fontSizeEl.addEventListener('input', () => {
            customFontSize = parseInt(fontSizeEl.value, 10);
            fontSizeVal.textContent = customFontSize; redraw();
        });
        textEl.addEventListener('input', () => redraw());
        document.getElementById('speakBtn').addEventListener('click', speakNow);

        function renderChips() {
            const samples = SAMPLE_TEXTS[langEl.value] || [];
            samplesEl.innerHTML = ''; samples.forEach(txt => {
                const chip = document.createElement('div'); chip.className = 'chip'; chip.textContent = txt;
                chip.onclick = () => { textEl.value = txt; redraw(); if (langEl.value === 'en-US') fetchIPA(txt); };
                samplesEl.appendChild(chip);
            });
        }

        loadVoices(); renderChips(); resizeCanvas();
    </script>
</body>

</html>