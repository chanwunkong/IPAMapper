<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase + GPT IPA ç”¢ç”Ÿå™¨ï¼ˆèªè¨€/å£éŸ³/å–®è©ï¼‰</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            padding: 20px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        label {
            font-size: 14px;
            color: #555;
            display: block;
            margin-bottom: 6px;
        }

        input,
        select,
        textarea,
        button {
            font-size: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }

        input,
        select,
        textarea {
            min-width: 260px;
        }

        button {
            cursor: pointer;
            font-weight: 600;
            background: #0ea5e9;
            color: #fff;
            border: none;
        }

        button.secondary {
            background: #64748b;
        }

        pre {
            background: #0b1220;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 12px;
            white-space: pre-wrap;
        }

        .muted {
            color: #6b7280;
            font-size: 13px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Firebase + Google ç™»å…¥ + å„²å­˜ GPT API Key + IPA ç”¢ç”Ÿ</h1>

    <div class="row">
        <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
        <button id="logoutBtn" class="secondary hidden">ç™»å‡º</button>
        <span id="userInfo" class="muted"></span>
    </div>

    <div id="keySection" class="row hidden">
        <div>
            <label>ä½ çš„ OpenAI API Keyï¼ˆåƒ…å€‹äººæ¸¬è©¦ï¼Œæœƒå­˜å› Firestore: users/{uid}ï¼‰</label>
            <input id="gptKey" placeholder="sk-..." style="width:360px;">
        </div>
        <div>
            <label>&nbsp;</label>
            <button id="saveKeyBtn">å„²å­˜ API Key</button>
            <div id="status" class="muted"></div>
        </div>
    </div>

    <hr>

    <!-- èªè¨€ / å£éŸ³ / å–®è© -->
    <div class="row">
        <div>
            <label for="langSel">èªè¨€</label>
            <select id="langSel">
                <option value="zh-TW">ä¸­æ–‡ï¼ˆç¹é«”ï¼‰ğŸ‡¹ğŸ‡¼</option>
                <option value="en-US">è‹±æ–‡ ğŸ‡ºğŸ‡¸</option>
                <option value="de-DE">å¾·æ–‡ ğŸ‡©ğŸ‡ª</option>
                <option value="es-ES">è¥¿ç­ç‰™èª ğŸ‡ªğŸ‡¸</option>
                <option value="pt-PT">è‘¡è„ç‰™èª ğŸ‡µğŸ‡¹</option>
                <option value="fr-FR">æ³•èª ğŸ‡«ğŸ‡·</option>
                <option value="it-IT">æ„å¤§åˆ©èª ğŸ‡®ğŸ‡¹</option>
                <option value="ru-RU">ä¿„èª ğŸ‡·ğŸ‡º</option>
                <option value="hi-IN">å°åœ°-çƒçˆ¾éƒ½èª ğŸ‡®ğŸ‡³</option>
                <option value="bn-BD">å­ŸåŠ æ‹‰èª ğŸ‡§ğŸ‡©</option>
                <option value="fa-IR">æ³¢æ–¯èª ğŸ‡®ğŸ‡·</option>
                <option value="ta-IN">å¦ç±³çˆ¾èª ğŸ‡®ğŸ‡³</option>
                <option value="ar-SA">é˜¿æ‹‰ä¼¯èª ğŸ‡¸ğŸ‡¦</option>
                <option value="tr-TR">åœŸè€³å…¶èª ğŸ‡¹ğŸ‡·</option>
                <option value="ja-JP">æ—¥èª ğŸ‡¯ğŸ‡µ</option>
                <option value="ko-KR">éŸ“èª ğŸ‡°ğŸ‡·</option>
                <option value="vi-VN">è¶Šå—èª ğŸ‡»ğŸ‡³</option>
                <option value="id-ID">å°å°¼-é¦¬ä¾†èª ğŸ‡®ğŸ‡©</option>
                <option value="th-TH">æ³°èª ğŸ‡¹ğŸ‡­</option>
                <option value="sw-KE">æ–¯ç“¦å¸Œé‡Œèª ğŸ‡°ğŸ‡ª</option>
            </select>
        </div>

        <div id="accentWrap">
            <label for="accentSel">å£éŸ³ / è®Šé«”</label>
            <select id="accentSel"></select>
            <div id="accentHint" class="muted"></div>
        </div>

        <div>
            <label for="wordInput">å–®è©</label>
            <input id="wordInput" placeholder="è¼¸å…¥è¦æ¨™è¨» IPA çš„å­—è©ï¼ˆä¾‹å¦‚ï¼šä½ å¥½ / Helloï¼‰" style="width:300px;">
        </div>
    </div>

    <div class="row">
        <div style="flex:1; min-width:320px;">
            <label>è‡ªå‹•ç”¢ç”Ÿçš„ Promptï¼ˆé€å¾€ GPTï¼‰</label>
            <textarea id="promptBox" rows="4" style="width:100%;" readonly></textarea>
        </div>
    </div>

    <div class="row">
        <button id="genBtn">ğŸš€ ç”¢ç”Ÿ IPA</button>
        <span id="runStatus" class="muted"></span>
    </div>

    <div class="row">
        <div style="flex:1; min-width:320px;">
            <label>çµæœ</label>
            <pre id="resultBox">ï¼ˆé€™è£¡æœƒé¡¯ç¤º IPAï¼‰</pre>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase åˆå§‹åŒ–ï¼ˆç”¨ä½ çš„å°ˆæ¡ˆè³‡è¨Šï¼‰ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqZLFskqgyiAEc127dh95rXsOPQVLSurM",
            authDomain: "test-5dbba.firebaseapp.com",
            projectId: "test-5dbba",
            storageBucket: "test-5dbba.appspot.com",
            messagingSenderId: "878665537417",
            appId: "1:878665537417:web:xxxxxx" // è«‹åˆ° Firebase å°ˆæ¡ˆè¨­å®šè¤‡è£½æ­£ç¢º appId
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- æ”¯æ´çš„èªè¨€å£éŸ³å°ç…§ï¼ˆè·Ÿä½ å‰é¢è¨­è¨ˆä¸€è‡´ï¼‰ ---
        const VOICE_VARIANTS = {
            "zh-TW": { include: ["cmn-TW", "cmn-CN"], labels: { "cmn-TW": "å°ç£", "cmn-CN": "ä¸­åœ‹" } },
            "en-US": { include: ["en-US", "en-GB", "en-AU", "en-CA"], labels: { "en-US": "ç¾å¼", "en-GB": "è‹±å¼", "en-AU": "æ¾³æ´²", "en-CA": "åŠ æ‹¿å¤§" } },
            "de-DE": { include: ["de-DE", "de-AT", "de-CH"], labels: { "de-DE": "å¾·åœ‹", "de-AT": "å¥§åœ°åˆ©", "de-CH": "ç‘å£«" } },
            "es-ES": { include: ["es-ES", "es-MX", "es-US", "es-AR"], labels: { "es-ES": "è¥¿ç­ç‰™", "es-MX": "å¢¨è¥¿å“¥", "es-US": "ç¾åœ‹", "es-AR": "é˜¿æ ¹å»·" } },
            "pt-PT": { include: ["pt-PT", "pt-BR"], labels: { "pt-PT": "æ­æ´²", "pt-BR": "å·´è¥¿" } },
            "fr-FR": { include: ["fr-FR", "fr-CA"], labels: { "fr-FR": "æ³•åœ‹", "fr-CA": "åŠ æ‹¿å¤§" } },
            "it-IT": { include: ["it-IT"], labels: { "it-IT": "ç¾©å¤§åˆ©" } },
            "ru-RU": { include: ["ru-RU"], labels: { "ru-RU": "ä¿„ç¾…æ–¯" } },
            "hi-IN": { include: ["hi-IN", "ur-PK"], labels: { "hi-IN": "å°åœ°èª", "ur-PK": "çƒçˆ¾éƒ½èª" } },
            "bn-BD": { include: ["bn-BD", "bn-IN"], labels: { "bn-BD": "å­ŸåŠ æ‹‰", "bn-IN": "å°åº¦å­ŸåŠ æ‹‰" } },
            "fa-IR": { include: ["fa-IR", "fa-AF"], labels: { "fa-IR": "ä¼Šæœ—", "fa-AF": "é˜¿å¯Œæ±—" } },
            "ta-IN": { include: ["ta-IN", "ta-LK"], labels: { "ta-IN": "å°åº¦", "ta-LK": "æ–¯é‡Œè˜­å¡" } },
            "ar-SA": { include: ["ar-SA", "ar-EG", "ar-XA"], labels: { "ar-SA": "æ²™çƒåœ°", "ar-EG": "åŸƒåŠ", "ar-XA": "æ±é˜¿æ‹‰ä¼¯" } },
            "tr-TR": { include: ["tr-TR"], labels: { "tr-TR": "åœŸè€³å…¶" } },
            "ja-JP": { include: ["ja-JP"], labels: { "ja-JP": "æ—¥æœ¬" } },
            "ko-KR": { include: ["ko-KR"], labels: { "ko-KR": "éŸ“åœ‹" } },
            "vi-VN": { include: ["vi-VN"], labels: { "vi-VN": "è¶Šå—ï¼ˆåŒ—éƒ¨ï¼‰" } },
            "id-ID": { include: ["id-ID", "ms-MY"], labels: { "id-ID": "å°å°¼èª", "ms-MY": "é¦¬ä¾†èª" } },
            "th-TH": { include: ["th-TH"], labels: { "th-TH": "æ³°åœ‹" } },
            "sw-KE": { include: ["sw-KE", "sw-TZ"], labels: { "sw-KE": "è‚¯äº", "sw-TZ": "å¦å°šå°¼äº" } }
        };

        // --- UI å…ƒç´  ---
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const keySection = document.getElementById('keySection');
        const gptKeyInput = document.getElementById('gptKey');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const statusEl = document.getElementById('status');

        const langSel = document.getElementById('langSel');
        const accentWrap = document.getElementById('accentWrap');
        const accentSel = document.getElementById('accentSel');
        const accentHint = document.getElementById('accentHint');
        const wordInput = document.getElementById('wordInput');
        const promptBox = document.getElementById('promptBox');
        const genBtn = document.getElementById('genBtn');
        const resultBox = document.getElementById('resultBox');
        const runStatus = document.getElementById('runStatus');

        let currentUser = null;
        let gptKey = null;

        // --- ç™»å…¥ / ç™»å‡º ---
        loginBtn.onclick = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(err => { alert("ç™»å…¥å¤±æ•—ï¼š" + err.message); console.error(err); });
        };
        logoutBtn.onclick = () => auth.signOut();

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userInfo.textContent = `å·²ç™»å…¥ï¼š${user.email}`;
                keySection.classList.remove('hidden');

                // è®€å– Firestore ä½¿ç”¨è€…çš„ gptApiKey
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    gptKey = doc.exists ? doc.data().gptApiKey : null;
                    if (gptKey) {
                        gptKeyInput.value = gptKey;
                        statusEl.textContent = "âœ… å·²è¼‰å…¥ Firestore ä¸­çš„ gptApiKey";
                    } else {
                        statusEl.textContent = "âš ï¸ Firestore å°šæœªå„²å­˜ gptApiKey";
                    }
                } catch (e) {
                    console.error(e);
                    statusEl.textContent = "âŒ è®€å– Firestore å¤±æ•—ï¼š" + e.message;
                }
            } else {
                currentUser = null;
                gptKey = null;
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                userInfo.textContent = '';
                keySection.classList.add('hidden');
            }
        });

        // --- å„²å­˜ Keyï¼šä½¿ç”¨ users/{uid} ä¸¦ mergeï¼Œé¿å…è¦†è“‹å…¶ä»–å°ˆæ¡ˆè³‡æ–™ ---
        saveKeyBtn.onclick = async () => {
            if (!auth.currentUser) return alert("è«‹å…ˆç™»å…¥ï¼");
            const key = gptKeyInput.value.trim();
            if (!key) return alert("è«‹è¼¸å…¥ API Key");
            try {
                await db.collection('users').doc(auth.currentUser.uid).set({
                    gptApiKey: key,
                    gptUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                gptKey = key;
                statusEl.textContent = "âœ… å·²åˆä½µæ›´æ–°åˆ° users/gptApiKeyï¼";
            } catch (err) {
                console.error(err);
                statusEl.textContent = "âŒ å„²å­˜å¤±æ•—ï¼š" + err.message;
            }
        };

        // --- æ ¹æ“šèªè¨€è¼‰å…¥å£éŸ³é¸é … ---
        function refreshAccents() {
            const lang = langSel.value;
            accentSel.innerHTML = '';
            const variant = VOICE_VARIANTS[lang];

            if (variant && variant.include?.length) {
                accentWrap.classList.remove('hidden');
                variant.include.forEach(code => {
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = variant.labels?.[code] || code;
                    accentSel.appendChild(opt);
                });
                accentHint.textContent = "ï¼ˆå¯é¸æ“‡ä¸»è¦å£éŸ³/è®Šé«”ï¼‰";
            } else {
                accentWrap.classList.add('hidden');
                accentHint.textContent = "";
            }
            updatePromptPreview();
        }

        // --- ç”Ÿæˆ Prompt é è¦½ ---
        function updatePromptPreview() {
            const lang = langSel.options[langSel.selectedIndex].textContent.replace(/ ?ğŸ‡§ğŸ‡©| ?ğŸ‡®ğŸ‡³| ?ğŸ‡¯ğŸ‡µ| ?ğŸ‡¹ğŸ‡¼| ?ğŸ‡ºğŸ‡¸| ?ğŸ‡©ğŸ‡ª| ?ğŸ‡ªğŸ‡¸| ?ğŸ‡µğŸ‡¹| ?ğŸ‡«ğŸ‡·| ?ğŸ‡®ğŸ‡¹| ?ğŸ‡·ğŸ‡º| ?ğŸ‡®ğŸ‡·| ?ğŸ‡¸ğŸ‡¦| ?ğŸ‡¹ğŸ‡·| ?ğŸ‡°ğŸ‡·| ?ğŸ‡»ğŸ‡³| ?ğŸ‡®ğŸ‡©| ?ğŸ‡¹ğŸ‡­| ?ğŸ‡°ğŸ‡ª/g, '').trim();
            const langCode = langSel.value;
            const hasAccent = !accentWrap.classList.contains('hidden');
            const accentCode = hasAccent ? accentSel.value : null;
            const accentLabel = hasAccent ? (VOICE_VARIANTS[langCode].labels?.[accentCode] || accentCode) : null;
            const word = (wordInput.value || "").trim();

            const prompt = `IPA for "${word}" in ${lang}${accentLabel ? ' (' + accentLabel + ')' : ''}. Only IPA.`;

            promptBox.value = prompt;
        }

        langSel.onchange = refreshAccents;
        accentSel.onchange = updatePromptPreview;
        wordInput.oninput = updatePromptPreview;

        // åˆå§‹è¼‰å…¥
        refreshAccents();

        // --- å‘¼å« OpenAIï¼ˆç”¨ Firestore å…§çš„ gptApiKey æˆ–è¼¸å…¥æ¡†çš„ï¼‰ ---
        async function callOpenAI(prompt) {
            const key = (gptKeyInput.value || '').trim();
            if (!key) throw new Error("å°šæœªæä¾› OpenAI API Key");
            const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${key}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0
                })
            });
            const data = await resp.json();
            if (!resp.ok) {
                throw new Error(data.error?.message || "OpenAI å‘¼å«å¤±æ•—");
            }
            return (data.choices?.[0]?.message?.content || "").trim();
        }

        // --- åŸ·è¡Œç”¢ç”Ÿ ---
        genBtn.onclick = async () => {
            const word = (wordInput.value || "").trim();
            if (!word) { alert("è«‹å…ˆè¼¸å…¥å–®è©"); return; }
            const prompt = promptBox.value;
            runStatus.textContent = "â³ æ­£åœ¨å‘ GPT ç”¢ç”Ÿ IPA...";
            resultBox.textContent = "ï¼ˆç”¢ç”Ÿä¸­â€¦ï¼‰";
            genBtn.disabled = true;

            try {
                const ipa = await callOpenAI(prompt);
                resultBox.textContent = ipa || "ï¼ˆæ²’æœ‰å›å‚³å…§å®¹ï¼‰";
                runStatus.textContent = "âœ… å®Œæˆ";
            } catch (e) {
                console.error(e);
                runStatus.textContent = "âŒ å¤±æ•—";
                resultBox.textContent = "éŒ¯èª¤ï¼š" + e.message;
            } finally {
                genBtn.disabled = false;
            }
        };
    </script>
</body>

</html>